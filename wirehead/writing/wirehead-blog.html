<div id="quartz-root" class="page">
<div id="quartz-body">
<div class="center" style="text-align: left;">
<div class="page-header">
<div class="popover-hint"></div>
</div>
<article class="popover-hint">

<hr />

<blockquote>
<p style="text-align: center;">Mike Doan, Sergey Plis</p>
<p style="text-align: center;">Aug 12, 2024</p>
</blockquote>

<hr />

<img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/parallel.png" alt="wirehead parallel" />

<hr />
<p style="text-align: center;">I. <a class="internal" href="#i-issues">Issues with synthetic data generators</a></p>
<p style="text-align: center;">II. <a class="internal" href="#ii-tldr-how-to-solve-this-problem-without-thinking-about-it">Wirehead Tutorial</a></p>
<p style="text-align: center;">III. <a class="internal" href="#iii-configuration">Configuration</a></p>
<p style="text-align: center;">IV. <a class="internal" href="#iv-deployment">Deployment</a></p>
<p style="text-align: center;">V. <a class="internal" href="#v-case-study--synthseg">Case study, SynthSeg</a></p>
<p style="text-align: center;">VI. <a class="internal" href="#vi-advanced-userland-tech">Advanced tech</a></p>
<p style="text-align: center;">VII. <a class="internal" href="#vii-wirehead-internals">Wirehead Internals</a></p>


<hr />
<p style="text-align: left;">There is one unchanging constant in machine learning: “data is king.” But what happens when you work in a field where the king doesn’t always want to get out of bed every morning?</p>
<p style="text-align: left;">Welcome to neuroimaging, where data is not only hard to come by, impossible to get manually labeled<sup><a id="user-content-fnref-1" class="internal" href="#user-content-fn-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup>, but also requires a ton of space<sup><a id="user-content-fnref-2" class="internal" href="#user-content-fn-2" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup>.</p>
<p style="text-align: left;">Many have stood up to challenge this lack of data by inventing methods to generate synthetic data — SynthSeg, SynthStrip, Synth, etc. They work really well<sup><a id="user-content-fnref-3" class="internal" href="#user-content-fn-3" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup>, but it has …</p>

<h2 id="i-issues" style="text-align: center;">I. Issues</h2>
<blockquote>If you’d like to skip ahead to the tutorial, go to section II.

If you’d like to skip ahead to Wirehead’s internal workings, go to section VII.</blockquote>

<hr />
<p style="text-align: left;">In late 2023, we at TReNDS attempted to make use of one such generator, <a class="external" href="https://arxiv.org/abs/2107.09559">SynthSeg</a>, to replicate the original results by training a MeshNet, our parameter-efficient model that’s very different from UNet used in the reference paper, on 300,000 synthetic samples<sup><a id="user-content-fnref-3-2" class="internal" href="#user-content-fn-3" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup>. However, early into the experimentation process, we noted three key things:</p>

<ol>
 	<li style="text-align: left;"><strong>Generation time</strong> was quite significant (2 seconds per sample on our A40). Generating that many samples using their setup (train -&gt; generate) would have taken us <strong>hundreds of hours.</strong></li>
 	<li style="text-align: left;"><strong>Data size was massive</strong>, the papers report training on 300,000 samples, which would have been 91 terabytes at 32 bit precision .</li>
 	<li>
<p style="text-align: left;"><strong>Hardware was greatly underutilized</strong>. glancing at nvtop showed us that our GPUs would be barely used during sample generation, before peaking for about 5 seconds while training on a new batch. On average, we got just <strong>around 30% GPU utilization</strong></p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/1process-wirehead.gif" alt="wh one process" />
<p style="text-align: left;">We could solve these issues by deploying the generator in parallel, but that posed its own set of issues:</p>

<ul>
 	<li style="text-align: left;"><strong>Where would we store the data?</strong> We still only had that much space on the cluster, and storing all of them at once would be infeasible. Some kind of <strong>cache</strong> was necessary.</li>
 	<li style="text-align: left;"><strong>How would we coordinate these distributed generators?</strong> We had SLURM, and could spin up 20 generators on the spot whenever we wanted, but it’s nontrivial to figure out how to make this process sync up with the training process.</li>
 	<li style="text-align: left;"><strong>How would we maintain high GPU utilization for training?</strong> The problem was clear — Our GPUs would idle if they didn’t have a sample to train on. Perfectly syncing up the throughput of generation to training is practically impossible, and overloading the training job with more samples than it needs would be wasteful of compute. So a workaround had to be figured out.</li>
</ul>

<hr />

<img class="aligncenter" src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/transparent_version.gif" alt="totally interpretable analogy" />
<p align="center">(pictured: physical analogy of wirehead)</p>

<h2 id="ii-tldr-how-to-solve-this-problem-without-thinking-about-it">II. TLDR (how to solve this problem without thinking about it)</h2>
<blockquote>In short, we made Wirehead, a distributed, async cache that lets you arbitrarily scale your synthetic data generation. It does this with no net storage overhead, and minimal compute requirements.

If you’d like to follow along the unit tests and examples from our repo, go <a class="external" href="https://github.com/neuroneural/wirehead">here</a>.</blockquote>

<hr />

/
<img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/wirehead.png" alt="wirehead components" />
<h3 id="1-install-mongodb">1. Install MongoDB</h3>
<p style="text-align: left;">This is the only real dependency we have for wirehead. Here are some ways to get it up and running on a local instance or a cluster.</p>

<ul>
 	<li style="text-align: left;"><a class="internal" href="#a-quick-mongodb-setup-ubuntu">Ubuntu Setup</a></li>
 	<li style="text-align: left;"><a class="internal" href="#b-quick-mongodb-setup-macos">macOS Setup</a></li>
 	<li style="text-align: left;"><a class="external" href="https://medium.com/@tholaday777/run-a-mongodb-docker-image-as-a-singularity-container-service-e68322df7abc">Singularity Setup</a></li>
</ul>
<p style="text-align: left;"><strong>Important note:</strong> the following instructions are for development and testing purposes only. for production deployments, please refer to the <a class="external" href="https://www.mongodb.com/docs/manual/administration/install-community/">official mongodb documentation</a> for secure and proper installation guidelines.</p>

<h4 id="a-quick-mongodb-setup-ubuntu" style="text-align: left;">a. Quick MongoDB Setup (<a class="external" href="https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/">Ubuntu</a>):</h4>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">apt-get</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">install</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">gnupg</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">curl</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">curl</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">-fsSL</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">https://www.mongodb.org/static/pgp/server-7.0.asc</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">|</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> \</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">gpg</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">-o</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">/usr/share/keyrings/mongodb-server-7.0.gpg</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> \</span></span>
<span data-line=""><span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">--dearmor</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">echo</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse"</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">|</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">tee</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">/etc/apt/sources.list.d/mongodb-org-7.0.list</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">apt-get</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">update</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">apt-get</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">install</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">-y</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongodb-org</span></span></code></pre>
</div>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Run MongoDB</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">systemctl</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">start</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongod</span></span></code></pre>
</div>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Stop MongoDB</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sudo</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">systemctl</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">stop</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongod</span></span></code></pre>
</div>
<h4 id="b-quick-mongodb-setup-macos" style="text-align: left;">b. Quick MongoDB Setup (<a class="external" href="https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-os-x/">MacOS</a>):</h4>
<p style="text-align: left;">Install <a class="external" href="https://brew.sh/">homebrew</a> if you haven’t:</p>

<pre><code>/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
</code></pre>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">brew</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">tap</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongodb/brew</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">brew</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">update</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">brew</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">install</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongodb-community@7.0</span></span></code></pre>
</div>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Run MongoDB</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">brew</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">services</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">start</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongodb-community@7.0</span></span></code></pre>
</div>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Stop MongoDB</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">brew</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">services</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">stop</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">mongodb-community@7.0</span></span></code></pre>
</div>
<h4 id="c-singularity-setup" style="text-align: left;">c. Singularity setup</h4>
<p style="text-align: left;">Refer to <a class="external" href="https://medium.com/@tholaday777/run-a-mongodb-docker-image-as-a-singularity-container-service-e68322df7abc">this excellent guide</a> from Tristan Holoday.</p>

<h3 id="2-python-environment-setup" style="text-align: center;">2. Python environment setup</h3>
<p style="text-align: left;">For SLURM usage, do be mindful of where your conda or venv is, and how to activate it, as we will need to reliably pass that through to our sbatch jobs.</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Note:</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># python version doesn't necessarily have to be 3.10</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># but this gives better support for some generation pipelines</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Conda</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">create</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">-n</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">python=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">3.10</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">activate</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># venv</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python3.10</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">-m</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">venv</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">source</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">venv/bin/activate</span></span></code></pre>
</div>
<h3 id="3-install-wirehead">3. Install wirehead</h3>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">pip</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">install</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span></span></code></pre>
</div>
<h3 id="4-doing-a-test-run">4. Doing a test run</h3>
<p style="text-align: left;">The unit test lives in examples/unit:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">git</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">clone</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">git@github.com:neuroneural/wirehead.git</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">cd</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead/examples/unit</span></span></code></pre>
</div>
<p style="text-align: left;">Configure the config.yaml file:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="yaml" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="yaml" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">MONGOHOST</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"localhost"</span> <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># hostname or ip of node hosting mongodb</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">DBNAME</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"unit-test"</span>    <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># name of database inside mongodb</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">SWAP_CAP</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">10</span>           <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># max size for write/read collection</span></span></code></pre>
</div>
<p style="text-align: left;"><strong>Important note:</strong> If you’re running MongoDB on a separate computer, you should make sure that it is accessible to wherever you’ve deployed wirehead. (This usually means contact your sysadmins). Verify with:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> pymongo </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> MongoClient</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># replace with hostname=localhost and port=27017 for defaults on a local instance</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">print</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"MongoDB is accessible"</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">MongoClient</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    host</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"your_hostname"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    port</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">your_port, serverSelectionTimeoutMS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">2000</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    ).</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">server_info</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">() </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">else</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"MongoDB is not accessible"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span></code></pre>
</div>
<p style="text-align: left;">Run the test</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">chmod</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">+x</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">test.sh</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">./test.sh</span></span></code></pre>
</div>
<p style="text-align: left;">If tests pass, you should get:</p>

<pre><code>All tests passed successfully! 
</code></pre>

<hr />

<h2 id="iii-configuration" style="text-align: center;">III. Configuration</h2>
<p style="text-align: left;"><img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/config.png" alt="wirehead state" /></p>

<blockquote>Deploying wirehead involves 3 main scripts (or utilities): A generator(s) (generator.py) a cache manager (manager.py) and a data fetcher (loader.py). In fact, loader is basically your favorite model training script and is fully decoupled from wirehead as long as you use our Dataset class (provided, but also part of our other package <a class="external" href="https://pypi.org/project/mindfultensors/">mindfultensors</a>).

All examples in this section can be found in wirehead/examples/unit.</blockquote>

<hr />

<h3 id="1-configyaml" style="text-align: left;">1. config.yaml</h3>
<p style="text-align: left;">All three of these scripts source a single config.yaml file, which consists of:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="yaml" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="yaml" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">MONGOHOST</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"localhost"</span>          <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># hostname or ip of node hosting mongodb</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">DBNAME</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"unit-test"</span>             <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># name of database inside mongodb</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">SWAP_CAP</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">10</span>                    <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># max size for write/read collection</span></span></code></pre>
</div>
<p style="text-align: left;">as well as some advanced configs (explained in a later section).</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="yaml" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="yaml" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">SAMPLE</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> [</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"data"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"label"</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">]       </span><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># string key associated with your samples</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">WRITE_COLLECTION</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"write"</span>       <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># name of write collecion on mongodb </span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">READ_COLLECTION</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"read"</span>         <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># name of read collection </span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">COUNTER_COLLECTION</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"counter"</span>   <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># name of counter collection used to keep index</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">TEMP_COLLECTION</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"temp"</span>         <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># name of temporary collection for movement ops</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">CHUNKSIZE</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">10</span>                   <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># size of chunks in MB for chunking data</span></span></code></pre>
</div>
<p style="text-align: left;">In order of increasing complexity, here’s how to configure each component of wirehead:</p>

<h3 id="2-managerpy" style="text-align: left;">2. manager.py</h3>
<p style="text-align: left;">This is the simplest, and doesn’t have to be changed if you’re running it as a standalone script.</p>
<p style="text-align: left;">WireheadManager doesn’t consume much compute, and thus can be deployed anywhere you want.</p>
<p style="text-align: left;">The only thing you need to specify is the path to your config file (in this case, “config.yaml”).</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> wirehead </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> WireheadManager</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">__name__</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">==</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"__main__"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    wirehead_runtime </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">WireheadManager</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(config_path</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"config.yaml"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    wirehead_runtime</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">run_manager</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span></code></pre>
</div>
<h3 id="3-loaderpy" style="text-align: left;">3. loader.py</h3>
<p style="text-align: left;">This script provides a simple way, an example really, to fetch a single sample from Wirehead</p>
<p style="text-align: left;">We provide two kinds of datasets for fetching dataL MongoheadDataset (dictionary-like) and MongoTupleheadDataset (tuple-like).</p>
<p style="text-align: left;">Similar to manager.py, it’s pretty much plug and play, and you can insert this into anywhere you’d like in your regular training script. the only thing you need to specify is the path to your config file (again, it is “config.yaml” in this example).</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> torch</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> wirehead </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> MongoheadDataset</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> MongoTupleheadDataset</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">idx </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> [</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">]</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">dict_dataset </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">MongoheadDataset</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(config_path</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"config.yaml"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">data </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> dataset</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">idx</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">sample</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> label </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> data</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">'input'</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">]</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> data</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">'label'</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">]</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">tuple_dataset </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">MongoTupleheadDataset</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(config_path</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"config.yaml"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">data </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> dataset</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">idx</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">]</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">sample</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> label </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> data</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">],</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> data</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span></span></code></pre>
</div>
<h3 id="4-generatorpy" style="text-align: left;">4. generator.py</h3>
<p style="text-align: left;">This is the heart of the operation, and where some explanation has to be done:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> numpy </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">as</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> wirehead </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> WireheadGenerator </span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">():</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">while</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        img </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">random</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rand</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        lab </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">random</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rand</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">yield</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> (img</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> lab)</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">__name__</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">==</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"__main__"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    brain_generator     </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    wirehead_runtime    </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">WireheadGenerator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        generator </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color=""> brain_generator,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        config_path </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"config.yaml"</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    )</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    wirehead_runtime</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">run_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span></code></pre>
</div>
<p style="text-align: left;">Like the manager and dataset, you need to specify your config_path (“config.yaml” in this example).</p>
<p style="text-align: left;">But one thing that’s different, is that now you also have to specify a <a class="external" href="https://wiki.python.org/moin/Generators">generator function</a> which <strong>yields</strong> a tuple containing your data. In this case, that generator looks like:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">():</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">while</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        img </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">random</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rand</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        lab </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">random</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rand</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">yield</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> (img</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> lab)</span></span></code></pre>
</div>
<p style="text-align: left;">Wirehead has to serialize the data before sending it off, and in this case we decided to use numpy ndarrays. If you instead wanted to use torch tensors or some other data type, make sure they’re <a class="external" href="https://docs.python.org/3/library/pickle.html">serializable</a> and live in the CPU before yielding them.</p>
<p style="text-align: left;">Then, all you have to do is plug an instance of your generator function, and the path to your config file into WireheadGenerator.</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">brain_generator     </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">wirehead_runtime    </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">WireheadGenerator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    generator </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color=""> brain_generator,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    config_path </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"config.yaml"</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span></code></pre>
</div>
<p style="text-align: left;">And then press play (this runs an infinite loop).</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">wirehead_runtime</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">run_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span></code></pre>
</div>
<p style="text-align: left;">If you’d prefer to generate only N samples instead of running an infinite loop, you can specify that in your generator function:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">N </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">10000</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">():</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> _ </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">range</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(N):</span>  <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># generate 10000 samples</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        img </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">random</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rand</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        lab </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> np</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">random</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rand</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">256</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">yield</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> (img</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> lab)</span></span></code></pre>
</div>
<p style="text-align: left;">WireheadGenerator will continue to push samples to the write collection as long as there are samples to yield. If your generator function fails or otherwise stops yielding, WireheadGenerator will self terminate.</p>


<hr />

<h2 id="iv-deployment" style="text-align: center;">IV. Deployment</h2>
<blockquote>
<p style="text-align: center;">Wirehead can be deployed both locally and on a SLURM managed cluster.</p>
<p style="text-align: center;">This section will guide you through both deployment scenarios.</p>
</blockquote>

<hr />

<h3 id="1-local" style="text-align: center;">1. Local</h3>
<p style="text-align: left;">For local deployment, you’ll need to run three main components: the generator, the manager, and your training script (which uses the loader). Here’s a step-by-step guide:</p>
<p style="text-align: left;"><strong>a. Start MongoDB:</strong>
Ensure MongoDB is running on your local machine. If it’s not already running, start it using the appropriate command for your operating system (e.g., <code>sudo systemctl start mongod</code> on Ubuntu).</p>
<p style="text-align: left;"><strong>b. Run the manager:</strong>
In a terminal, navigate to your Wirehead directory and run:</p>

<pre><code>python manager.py
</code></pre>
<p style="text-align: left;"><strong>c. Run the generator:</strong>
Open another terminal, navigate to your Wirehead directory, and run:</p>

<pre><code>python generator.py
</code></pre>
<p style="text-align: left;"><strong>d. Run your training script:</strong>
In a third terminal, run your training script that uses the Wirehead loader.</p>
<p style="text-align: left;">Make sure all scripts are using the same configuration file (config.yaml) pointing to your local MongoDB instance.</p>

<h3 id="2-slurm" style="text-align: center;">2. SLURM</h3>
<p style="text-align: left;">For deployment on a SLURM-managed cluster, you’ll need to create SLURM job scripts for the manager and generator. Your training script will also need to be submitted as a SLURM job. Here’s how to set it up:</p>
<p style="text-align: left;"><strong>a. Manager Job Script:</strong>
Create a file named <code>manager_job.sh</code>:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#!/bin/bash</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --job-name=wirehead_manager</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --nodes=1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -c 2</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --mem=4g</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --output=./log/manager_output_%j.log</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --error=./log/manager_error_%j.log</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --time=24:00:00</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -p qTRDGPU</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -A psy53c17</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">echo</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"Starting Wirehead Manager on $(</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">hostname</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">)"</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">activate</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead_dev</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">manager.py</span></span></code></pre>
</div>
<p style="text-align: left;"><strong>b. Generator Job Script:</strong>
Create a file named <code>generator_job.sh</code>:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#!/bin/bash</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --job-name=wirehead_generator</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --nodes=1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -c 16</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --mem=50g</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --gres=gpu:A40:1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --output=./log/generate_output_%A_%a.log</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --error=./log/generate_error_%A_%a.log</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --time=06:00:00</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -p qTRDGPU</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -A psy53c17</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --array=0-2</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">echo</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"This is a Wirehead generator job on $(</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">hostname</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">)"</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">activate</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead_dev</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">generator.py</span></span></code></pre>
</div>
<p style="text-align: left;"><strong>c. Submit the jobs:</strong>
First, submit the manager job:</p>

<pre><code>sbatch manager_job.sh
</code></pre>
<p style="text-align: left;">Then, submit the generator job:</p>

<pre><code>sbatch generator_job.sh
</code></pre>
<p style="text-align: left;"><strong>d. Training Job:</strong>
Modify your training script to use the Wirehead loader, and submit it as a SLURM job.</p>
<p style="text-align: left;">Notes on the SLURM configuration:</p>

<ul style="text-align: left;">
 	<li>The manager job is set to run for 24 hours. Adjust this time as needed for your workload.</li>
 	<li>The generator job is set up as an array job (—array=0-2), which will create 3 identical jobs. This allows you to run multiple generators in parallel.</li>
 	<li>Both jobs use the qTRDGPU partition and the psy53c17 account. Adjust these according to your cluster’s configuration.</li>
 	<li>The generator job requests an A40 GPU. Modify this according to your available hardware.</li>
 	<li>Both jobs activate a conda environment named ‘wirehead_dev’. Ensure this environment exists and contains all necessary dependencies.</li>
</ul>
<p style="text-align: left;">Remember to modify the config.yaml file to point to the MongoDB instance on your cluster. You may need to work with your system administrators to ensure MongoDB is properly set up and accessible from your compute nodes.</p>
<p style="text-align: left;">By using this SLURM setup, you can easily scale your data generation across multiple nodes, significantly speeding up your workflow.</p>


<hr />

<h2 id="v-case-study--synthseg" style="text-align: left;">V. Case study — SynthSeg</h2>
<p style="text-align: left;"><img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/parallel.png" alt="wirehead parallel" /></p>
<p style="text-align: left;">Recall this diagram. This section will be discussing the use of wirehead for scaling SynthSeg data generation.</p>
<p style="text-align: left;">First, let’s start with a baseline: (running SynthSeg generation on a loop and measuring the samples per second)</p>

<h3 id="1-baseline" style="text-align: center;">1. Baseline</h3>
<p style="text-align: left;">We need to modify our <a class="internal" href="#4-generatorpy">generator.py</a> script to accept the SynthSeg generator:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> time </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> time</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> nobrainer</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">processing</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">brain_generator </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> BrainGenerator</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">from</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> preprocessing </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> preprocessing_pipe </span><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># just simple label maps and normalization</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">DATA_FILES </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> [</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"example.nii.gz"</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">]</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">file_id</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">"""Creates an iterator that returns data for mongo.</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Should contain all the dependencies of the brain generator</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Preprocessing should be applied at this phase</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    yields : Tuple(np.ndarray, np.ndarray)</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    """</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    training_seg </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> DATA_FILES</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">file_id</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    brain_generator </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">BrainGenerator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        training_seg,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        randomise_res</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">False</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    )</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">print</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">f</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"Generator </span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">{</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">file_id</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">}</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">: SynthSeg is using </span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">{</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">training_seg</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">}</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">, flush</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    start </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">time</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span> <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># for benchmarking</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">while</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        img</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> lab </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">preprocessing_pipe</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(brain_generator.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">generate_brain</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">())</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">yield</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> (img</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> lab)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        gc</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">collect</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span> <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># for memory stability, will be important later</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">print</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">f</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"Time diff : </span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">{</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">start </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">time</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">}</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        start </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">time</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">__name__</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">==</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"__main__"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    brain_generator </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">create_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    wirehead_generator </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">WireheadGenerator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        generator</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">brain_generator, config_path</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"config.yaml"</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    )</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    wirehead_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">run_generator</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span></code></pre>
</div>
<p style="text-align: left;">Basically, the exact same thing as the example above, just with some extra stuff for preprocessing, and feeding in a special data file for conditioning the generator.</p>
<p style="text-align: left;">For comparison reasons, we’ll be measuring using the time between swaps. Spinning up an instance of that gives us the following times:</p>

<pre><code>Manager: Time: 1722892244.7662659 Generated samples so far 100
Manager: Time: 1722892408.0713165 Generated samples so far 200
Manager: Time: 1722892570.7747226 Generated samples so far 300
Manager: Time: 1722892734.1165183 Generated samples so far 400
</code></pre>
<p style="text-align: left;">Subtracting time between swaps, we get on average 162 seconds per 100 samples, or 1.62 seconds per sample (0.62 samples per second). This is now our baseline.</p>
<p style="text-align: left;">For reference, let’s also check out the hardware utilization plots, this is <a class="external" href="https://github.com/XuehaiPan/nvitop">nvitop</a> btw</p>
<p style="text-align: left;"><img class="alignnone" src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/1process-wirehead.gif" alt="wh one process" /></p>
<p style="text-align: left;">Notice anything?</p>

<ul style="text-align: left;">
 	<li>GPU util: bottom right plot: Spotty, varying from 0-80%, averaging 30% — WEAK</li>
 	<li>GPU mem: top right plot. stable 11% — WEAK</li>
 	<li>CPU util: top left plot ~9% — WEAK</li>
 	<li>CPU mem: bottom left plot 9.4 GB — WEAK</li>
</ul>
<h2 id="2-process-parallelism" style="text-align: center;">2. Process parallelism</h2>
<p style="text-align: left;">Surely we can fit more processes on the same node. How about 8?</p>
<p style="text-align: left;">We can do this by just launching 8 python processes in parallel in the terminal:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#!/bin/bash</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">NUM_GENERATORS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">8</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">init</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">bash</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">activate</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span></span>
                                                                                                            
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> i </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">$(</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">seq</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">$((NUM_GENERATORS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">))</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">)</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">; </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">do</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">generator.py</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> $NUM_GENERATORS $i </span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">&amp;</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    pids</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">+=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">($!)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">done</span></span>
                                                                                                            
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> pid </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"${pids[@]}"</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">; </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">do</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">wait</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> $pid</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">done</span></span></code></pre>
</div>
<p style="text-align: left;">Doing this nets us these times:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722891632.5399084</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">100</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722891671.506585</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">200</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722891710.6051934</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">300</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722891749.7454906</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">400</span></span></code></pre>
</div>
<p style="text-align: left;">On average, we’re getting about 39 seconds per 100 samples. This means the generator is going at 0.39 seconds per sample (aka 2.56 samples per second). This translates to a 4.1x speedup. Not quite linear, but SynthSeg is quite resource intensive so.</p>
<p style="text-align: left;">Let’s look at the hardware util plots again:</p>
<p style="text-align: left;"><img class="aligncenter" src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/8process-wirehead.gif" alt="wh eight process" /></p>
<p style="text-align: left;">Notice anything?</p>

<ul style="text-align: left;">
 	<li>GPU util: bottom right plot: &gt; 90% utilization always — STRONG</li>
 	<li>GPU mem: top right plot. 77.7% — STRONG</li>
 	<li>CPU util: ~23% — STRONGER</li>
 	<li>CPU mem: 24 GB — STRONG</li>
</ul>
<h2 id="3-node-paralellism">3. Node paralellism</h2>
<p style="text-align: left;">Let’s kick it up a notch. We can deploy multiple jobs in parallel using SLURM, how about we fire up 8 jobs?</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#!/bin/bash</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --job-name=wirehead</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --nodes=1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH -c 64</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --mem=128g</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --gres=gpu:A40:1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --array=0-7 # this means 8 nodes will be allocated </span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">NUM_GENERATORS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">8</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">init</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">bash</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">activate</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> i </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">$(</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">seq</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">$((NUM_GENERATORS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">))</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">)</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">; </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">do</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">generator.py</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> $NUM_GENERATORS $i </span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">&amp;</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">  pids</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">+=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">($!)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">done</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> pid </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"${pids[@]}"</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">; </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">do</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">wait</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> $pid</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">done</span></span></code></pre>
</div>
<p style="text-align: left;"><strong>drum rolls please</strong> here’s the numbers:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722969207.606956</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">30000</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722969256.0353918</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">31000</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">Manager:</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Time:</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722969305.0466542</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">Generated</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">samples</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">so</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">far</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">32000</span></span></code></pre>
</div>
<p style="text-align: left;">So an average of about 0.049 seconds per sample or 20.4 samples per second. So about a 32x speedup compared to baseline, and a LINEAR 8x speedup compared to the process parallel example.</p>
<p style="text-align: left;">Here’s an example of one of our experiments training on synthetic data with wirehead. Left plot is unoptimized, single node synthseg. Right plot is multi node, multi node wirehead.</p>
<p style="text-align: left;">Both are training on the same hardware (1xA100).</p>
<p style="text-align: left;">With a faster data generation rate, a node parallel wirehead session serving a training process on the same GPU in just 40 minutes can achieve better results than a training session served by a non-parallel wirehead session that runs for 4 hours.</p>

<div style="display: flex; justify-content: space-between; text-align: left;"><img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/wh-naive-loss.png" alt="First Image Description" width="45%" />
<img src="https://raw.githubusercontent.com/spikedoanz/public/master/wirehead/wh-dist-loss.png" alt="Second Image Description" width="45%" /></div>

<hr />

<h1 id="warning-advanced-section-ahead" style="text-align: center;"><strong>Warning: Advanced Section Ahead</strong></h1>
<blockquote>The following section is intended for users who are already comfortable with deploying and using wirehead for normal training jobs.

None of these are necessary for normal usage of wirehead, but might be necessary for experiments with scaling using wirehead, as well as benchmarking and debugging purposes.</blockquote>

<hr />

<h2 id="vi-advanced-userland-tech" style="text-align: center;">VI. Advanced userland tech</h2>
<blockquote>So far, Wirehead might seem quite barebones, having basically just the minimum to function as a reliable distributed data structure.

We decided to leave many of the decisions (such as how to manage and schedule generators) to the end user.

Accommodating all the different ways a generator could be handled, or deployed, would have significantly bloated our code.</blockquote>

<hr />
<p style="text-align: left;">However, that doesn’t mean we’re going to leave you out to dry.</p>
<p style="text-align: left;">Here are some advanced tech that we’ve found during testing to make your life a lot easier while scaling your synthetic data generators:</p>

<h3 id="1-slurm-tricks" style="text-align: center;">1. Slurm tricks</h3>
<p style="text-align: left;">The first and most obvious one is to leverage many of the features that slurm provides out of the box to avoid having to having to heterogenize your generators.</p>

<ul style="text-align: left;">
 	<li><a class="external" href="https://marcc-hpc.github.io/tutorials/shortcourse_jobarrays.html">Slurm arrays</a> for scheduling parallel jobs:</li>
</ul>
<p style="text-align: left;">Example:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#!/bin/bash</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --job-name=wirehead</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --nodes=1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --gres=gpu:A40:1</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH --array=0-19  # &lt;&lt; this lets you run 20 jobs in parallel, indexed 0..19</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">worker.py</span></span></code></pre>
</div>
<p style="text-align: left;">You can also use the slurm worker_id (the index from the example above) within the python runtime. This is useful for selecting:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">import</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> os</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">worker_id </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> os</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">getenv</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"SLURM_ARRAY_TASK_ID"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">, </span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"0"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">training_seg </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> DATA_FILES</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">worker_id </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">%</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">len</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(DATA_FILES)]</span> <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># selects a different segment to condition based on id</span></span></code></pre>
</div>
<h3 id="2-running-multiple-python-processes" style="text-align: center;">2. Running multiple python processes</h3>
<p style="text-align: left;">Assuming you don’t have egregious memory leaks, you can also deploy multiple generators in parallel in multiple python processes<sup><a id="user-content-fnref-7" class="internal" href="#user-content-fn-7" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="bash" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="bash" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#!/bin/bash</span></span>
                                                                               
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#SBATCH ...</span></span>
                                                                               
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">NUM_GENERATORS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">8</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">init</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">bash</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">conda</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">activate</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">wirehead</span></span>
                                                                               
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> i </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">$(</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">seq</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">$((NUM_GENERATORS</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">))</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">)</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">; </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">do</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">python</span> <span style="color: var(--shiki-token-string);" data-darkreader-inline-color="">generator.py</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> $NUM_GENERATORS $i </span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">&amp;</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">  pids</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">+=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">($!)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">done</span></span>
                                                                               
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> pid </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"${pids[@]}"</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">; </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">do</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">wait</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> $pid</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">done</span></span></code></pre>
</div>
<h3 id="3-benchmarks-and-debugging" style="text-align: center;">3. Benchmarks and debugging</h3>
<h4 id="a-fetching-single-samples">a. Fetching single samples</h4>
<p style="text-align: left;">You can do this by using the MongoheadDataset class:</p>

<pre><code>(venv) examples/unit § python
Python 3.10.14 (main, Jul 12 2024, 17:45:26)
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; from wirehead import MongoheadDataset

&gt;&gt;&gt; dataset = MongoheadDataset("config.yaml")
Dataset: config loaded from config.yaml
Dataset: Data is ready

&gt;&gt;&gt; x, y = batch[0]['input'], batch[0]['label']

&gt;&gt;&gt; x.shape, y.shape
(torch.Size([256, 256, 256]), torch.Size([256, 256, 256]))
</code></pre>
<h4 id="b-wireheadmanager-will-provide-some-logging-information" style="text-align: left;">b. WireheadManager will provide some logging information</h4>
<pre><code>Manager: SWAP!
    Time: 1722356716.8162937 
    Generated samples: 4800
    Documents deleted: 0
Manager: SWAP!
    Time: 1722356737.930378 
    Generated samples so far 4850
    Documents deleted: 10
</code></pre>
<h4 id="c-how-to-interpret-results" style="text-align: left;">c. How to interpret results</h4>
<p style="text-align: left;">Every time there is a swap, the manager will log:</p>

<pre><code>Time:               current unix time
Generated samples:  how many samples generated in total so far
Documents deleted:  how corrupted / incomplete samples were thrown away
</code></pre>
<p style="text-align: left;">You can use these logs to get some figures for benchmarking:</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">&gt;&gt;&gt;</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722356737.930378</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1722356716.8162937</span></span>
<span data-line=""><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">21.114</span>      <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># seconds between swaps</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">&gt;&gt;&gt;</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">4850</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">4800</span></span>
<span data-line=""><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">50</span>          <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># samples between swaps </span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">&gt;&gt;&gt;</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">50</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">/</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">21.114084243774414</span></span>
<span data-line=""><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">2.368</span>       <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># samples per second</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">&gt;&gt;&gt;</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">21.114084243774414</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">/</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">50</span></span>
<span data-line=""><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0.422</span>       <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># seconds per sample</span></span></code></pre>
</div>

<hr />

<h2 id="vii-wirehead-internals" style="text-align: center;">VII. Wirehead Internals</h2>
<blockquote>So we looked at this problem and realized: What we need is a <strong>distributed<sup><a id="user-content-fnref-4" class="internal" href="#user-content-fn-4" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup> circular<sup><a id="user-content-fnref-5" class="internal" href="#user-content-fn-5" data-footnote-ref="" aria-describedby="footnote-label">6</a></sup> cache<sup><a id="user-content-fnref-6" class="internal" href="#user-content-fn-6" data-footnote-ref="" aria-describedby="footnote-label">7</a></sup></strong>. We made one, and called it <a class="external" href="https://github.com/neuroneural/wirehead">Wirehead</a>.</blockquote>

<hr />
<p style="text-align: left;">Okay what do you need for a cache? You basically just need:</p>

<ol style="text-align: left;">
 	<li>A way to <strong>put</strong> data in.</li>
 	<li>A way to <strong>get</strong> data out.</li>
 	<li>A way to <strong>swap</strong> old data with fresh data.</li>
</ol>
<p style="text-align: left;">Why a cache? And not some other strategy? Well, a circular cache:</p>

<ul style="text-align: left;">
 	<li><strong>Eliminates the storage issue</strong>. Using a cache means we toss out the data after we’re done using it for training.</li>
 	<li><strong>Provides a convenient way to deal with the coordination issue</strong>. Using a cache means that we have a way to hook up our many generators to our training job.</li>
 	<li><strong>Eliminates the issue of low GPU utilization</strong>. Our training job would always have samples to train on.</li>
</ul>
<p style="text-align: left;">Now the thing though, is that writing distributed systems software is <a class="external" href="http://nil.csail.mit.edu/6.824/2020/">hard</a>. If we did this from scratch, it would likely crash and burn every 5 minutes.</p>
<p style="text-align: left;">So we didn’t, and instead relied on some battle hardened enterprise software. Enter <a class="external" href="https://www.mongodb.com/">MongoDB</a> — distributed, non-blocking, and basically nuclear proof. It was exactly what we needed.</p>
<p style="text-align: left;">So all we have to do now is to write those three components, and let MongoDB handle the ugly details of distributed systems reliability. (not really true, we still have to do some careful distributed system design).</p>
<p style="text-align: left;">Some terminology before we dive into the explanations:</p>

<ul style="text-align: left;">
 	<li>swap time: refers to the operations and time during which swap from write to read happens.</li>
 	<li>read time: refers to the operations and time during which a read operation happens.</li>
 	<li>chunkified: turning a large file of N bytes into N / CHUNKSIZE chunks.</li>
</ul>
<p style="text-align: left;">Here are the parts that we wrote, and a brief explanation of how they work.</p>

<h3 id="1-put" style="text-align: center;">1. Put</h3>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">generate_and_insert</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">""" Fetch from generator and inserts into mongodb """</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 0. Fetch data from generator</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    data </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">next</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self.generator)</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 1. Get the correct index for this current sample</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    index </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">get_current_idx</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 2. &lt;&lt;&lt;&lt; Turn the data into chunks &gt;&gt;&gt;&gt;</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    chunks </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">chunkify</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(data, index)</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 3. Push to mongodb + error handling</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> index </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">&lt;</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">swap_cap</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">push_chunks</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(chunks)</span></span></code></pre>
</div>
<p style="text-align: left;">For every sample created by a generator, the following steps are applied to that data:</p>

<ol style="text-align: left;">
 	<li>A corresponding index is fetched for the sample.</li>
 	<li>The data is turned into chunks of CHUNKSIZE megabytes.</li>
 	<li>The chunks are pushed in order into MongoDB. (to be reassembled later)</li>
</ol>
<h4 id="a-what-is-index" style="text-align: left;">a. What is index?</h4>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">get_current_idx</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">"""Get current index of sample in write collection"""</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    dbc </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">db</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">collectionc</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    counter_doc </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> dbc</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">find_one_and_update</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        {</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"_id"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: </span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"uniqueFieldCounter"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">},</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        {</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"$inc"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: {</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"sequence_value"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: </span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">}},</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        return_document</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">ReturnDocument.BEFORE,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    )</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> counter_doc</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"sequence_value"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span></span></code></pre>
</div>
<p style="text-align: left;">Index is fetched from the counter collection inside our MongoDB collection. During fetch time, it both grabs the index, and also atomically increments the counter collection.</p>
<p style="text-align: left;">This ensures that every generated sample will have a unique id before being pushed into the database. This id will be the same id that <code>__getitem__</code> fetched by the dataset class.</p>

<h4 id="b-what-is-chunkifying-doing" style="text-align: left;">b. What is chunkifying doing?</h4>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">chunkify</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">data</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">index</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    chunks </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> []</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    binobj </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> data</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    kinds </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">sample</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> i</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> kind </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">enumerate</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(kinds):</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        chunks </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">+=</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">list</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">chunk_binobj</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">tensor2bin</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(torch.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">from_numpy</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(binobj[i])),</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">                index,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">                kind,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">                self.chunksize,</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">            )</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        )</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> chunks</span></span></code></pre>
</div>
<p style="text-align: left;">Because MongoDB has a collection size cap of <a class="external" href="https://www.mongodb.com/docs/v5.2/reference/limits/">16MB</a>, we have to chunkify our data into multiple chunks. The size of our chunks is determined by the CHUNKSIZE variable in config.yaml.</p>
<p style="text-align: left;">Note that because our data is getting chunkified, we’ll have to reassemble them at read time.</p>

<h3 id="2-get" style="text-align: center;">2. Get</h3>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">__getitem__</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">batch</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">"""</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Fetch all samples for ids in the batch and return as tuples</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    """</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 1. Get chunk indices of samples from collection given index</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    samples </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">list</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self.collection[</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"bin"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">].</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">find</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        {   self.id: { </span></span>
<span data-line=""><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"$in"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: [ self.indices[_] </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color=""> _ </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color=""> batch] },</span></span>
<span data-line=""><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"kind"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: { </span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"$in"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: self.sample },             </span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        },  self.fields, )</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">    )</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 2. Create a batch to store samples into</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    results </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> []</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">id</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> batch</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 3. Fetch chunks from chunk indices fetched in # 1.</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        samples_for_id </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> [</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">            sample </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> sample </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> samples </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> sample</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">id</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">==</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">indices</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">id</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">]</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        ]</span></span>
        
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 4. &gt;&gt;&gt;&gt; Recreate data from chunks &lt;&lt;&lt;&lt;</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        data </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">make_serial</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(samples_for_id, self.sample[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">0</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">])</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        label </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">make_serial</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(samples_for_id, self.sample[</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">])</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        data </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">normalize</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">transform</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(data).</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">float</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">())</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        label </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">transform</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(label)</span></span>
 
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        results</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">append</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">((data, label))</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> results</span></span></code></pre>
</div>
<p style="text-align: left;">In short, to fetch a batch of data from Wirehead, the following operations are executed:</p>

<ol style="text-align: left;">
 	<li>Get chunk indices of samples from collection given index.</li>
 	<li>Create a batch to store samples into.</li>
 	<li>Fetch chunks from chunk indices fetched in # 1.</li>
 	<li>Reassemble data from chunks.</li>
</ol>
<h3 id="3-swap" style="text-align: center;">3. Swap</h3>
<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">swap</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">generated</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">"""</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Moves data from write collection to read collection</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Deletes old write collection</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Maintains data integrity in between</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    """</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    time</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sleep</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">2</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span> <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 0. Buffer for incomplete operations</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    generated </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">+=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">swap_cap</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 1. Rename the write collection to a temporary collection for processing</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">db</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">collectionw</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">].</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rename</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self.collectiont, dropTarget</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 2. Reset the counter collection, push indices are now at 0 and resumed</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">reset_counter_and_collection</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">()</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 3. Remove excess chunks from the temporary collection</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">    result </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">db</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">collectiont</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">].</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">delete_many</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">        {</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"id"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: { </span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"$gt"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: self.swap_cap </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">-</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color=""> }})</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 4. Go through collection, and reindex chunks into contiguous sections</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#       this operation is O(swap_cap)</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">#    Also verify that the collection is uncorrupted while you're at it</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">verify_collection_integrity</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self.db[self.collectiont]):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 5. Atomically replace read collection with temp collection</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">db</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">collectiont</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">].</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">rename</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self.collectionr, dropTarget</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># 6. Flag the database as having swapped once and ready to be read</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">        self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">db</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">[</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"status"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">].</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">insert_one</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">({</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"swapped"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">: </span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">})</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> generated </span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">else</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span> <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># if collection is corrupted</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">print</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"Manager: Corrupted collection detected, skipping swap"</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> generated </span></span></code></pre>
</div>
<p style="text-align: left;">Once a SWAP_CAP number of samples is in the write collection, a swap is executed which replaces the current read collection with a fresh batch of samples from the write collection. The following operations happen in order:</p>

<ol style="text-align: left;">
 	<li>Rename the write collection to a temporary collection for processing.</li>
 	<li>Reset the counter collection, setting push indices to 0 and resuming.</li>
 	<li>Remove excess chunks from the temporary collection, keeping only up to the swap cap limit.</li>
 	<li>Reindex chunks in the temporary collection into contiguous sections (O(swap_cap) operation). Also verifies that the write collection doesn’t have any incomplete samples.</li>
 	<li>Atomically replace the read collection with the temporary collection.</li>
 	<li>Flag the database as having swapped once and ready to be read.</li>
</ol>
<h4 id="a-how-swaps-happen-instantaneously" style="text-align: left;">a. How swaps happen ‘instantaneously’</h4>
<p style="text-align: left;">During swap time, the way that data ‘moves’ from the write collection to the read collection isn’t by actually moving any data.</p>
<p style="text-align: left;">Instead, what we do is we atomically rename the write collection <strong>into</strong> the read collection, while simultaneously dropping the read collection. This operation happens instantaneously.</p>

<h4 id="b-how-swaps-happen-safely" style="text-align: left;">b. How swaps happen safely</h4>
<p style="text-align: left;">One thing to note though, is that <code>self.db[self.collectiont].rename(self.collectionr, dropTarget=True)</code> only has <strong>partial</strong> atomicity — meaning that the renaming operation and dropTarget operation are independently atomic — there is a few milisecond gap during which there is no read collection.</p>
<p style="text-align: left;">To rememdy this, we’ve also implemented some error handling on the Dataset class to make it able to refetch should a swap happen mid fetch.</p>

<div style="text-align: left;" data-rehype-pretty-code-fragment="">
<pre style="background-color: var(--shiki-color-background);" tabindex="0" data-language="python" data-theme="default" data-darkreader-inline-bgcolor=""><code data-language="python" data-theme="default"><span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">retry_on_eof_error</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">retry_count</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">verbose</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">False</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">"""</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    Error handling for reads that happen mid swap</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color="">    """</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">decorator</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">func</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">wrapper</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">batch</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">*</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">args</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">**</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">kwargs</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">            myException </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span> <span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">Exception</span>    <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Default Exception if not overwritten</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">for</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> attempt </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">in</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">range</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(retry_count):</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">try</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">func</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(self, batch, </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">*</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">args, </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">**</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">kwargs)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">except</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> (</span></span>
<span data-line=""><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">EOFError</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">                        OperationFailure</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">                ) </span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">as</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> exception</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span>    <span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># Specifically catching EOFError</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">keeptrying</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">if</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> verbose</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">print</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">f</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"EOFError caught. Retrying </span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">{</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">attempt</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">+</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1}</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">/</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">{</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">retry_count</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">}</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"</span></span>
<span data-line=""><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">                            )</span></span>
<span data-line=""><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">                        time</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">.</span><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">sleep</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">1</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">continue</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">else</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">:</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">raise</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> exception</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">raise</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">myException</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-string-expression);" data-darkreader-inline-color="">"Failed after multiple retries."</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> wrapper</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">return</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color=""> decorator</span></span>
 
<span data-line=""><span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">@retry_on_eof_error</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">(retry_count</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">3</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">, verbose</span><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">=</span><span style="color: var(--shiki-token-constant);" data-darkreader-inline-color="">True</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">)</span></span>
<span data-line=""><span style="color: var(--shiki-token-keyword);" data-darkreader-inline-color="">def</span> <span style="color: var(--shiki-token-function);" data-darkreader-inline-color="">__getitem__</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">(</span><span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">self</span><span style="color: var(--shiki-token-punctuation);" data-darkreader-inline-color="">,</span> <span style="color: var(--shiki-token-parameter);" data-darkreader-inline-color="">batch</span><span style="color: var(--shiki-color-text);" data-darkreader-inline-color="">):</span></span>
<span data-line=""><span style="color: var(--shiki-token-comment);" data-darkreader-inline-color=""># rest of the normal __getitem__ function</span></span></code></pre>
</div>
</article>

<hr />

<article class="popover-hint">
<section class="footnotes" data-footnotes="">
<h2 id="footnote-label" class="sr-only">Footnotes<a class="internal" tabindex="-1" href="#footnote-label" aria-hidden="true"> §</a></h2>
<ol>
 	<li id="user-content-fn-1">unless you want to pay about $300/hour for a time of a radiologist that has better things to do than carefully assigning <span class="math math-inline"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="mord">25</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span style="top: -3.063em; margin-right: 0.05em;"><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span> voxels to 18 classes</li>
 	<li id="user-content-fn-2">a typical image of shape 256x256x256, at 32 bits per voxel is <strong>64 megabytes</strong>.</li>
 	<li id="user-content-fn-3"><a class="external" href="https://arxiv.org/abs/2107.09559">https://arxiv.org/abs/2107.09559</a></li>
 	<li id="user-content-fn-7">We tried python’s multiprocessing library but found the gains not worth it in exchange for their added cost to complexity.</li>
 	<li id="user-content-fn-4"><a class="external" href="https://en.wikipedia.org/wiki/Distributed_computing">https://en.wikipedia.org/wiki/Distributed_computing</a></li>
 	<li id="user-content-fn-5"><a class="external" href="https://en.wikipedia.org/wiki/Circular_buffer">https://en.wikipedia.org/wiki/Circular_buffer</a></li>
 	<li id="user-content-fn-6"><a class="external" href="https://en.wikipedia.org/wiki/Cache_(computing)">https://en.wikipedia.org/wiki/Cache_(computing)</a></li>
</ol>
</section>
</article></div>
</div>
</div>
